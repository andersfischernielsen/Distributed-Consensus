% !TeX root = DistributedConsensus.tex
% !TeX spellcheck = en_GB
\chapter{Connecting Histories} 
\label{chap:connecting-histories}
	This chapter defines the merging of logs across multiple events into one consistent history. Furthermore it describes how it is possible to simplify a graph of logs into an order of execution.
	
	\begin{definition}
		A \textit{\textbf{Consistent History}} is a (possibly combined) history, A, which for every history that was part of the creation of history A, if there is a path from one action to another, this path must also exist in history A. Furthermore related actions must be combined to create the most restricted order of execution possible.
	\end{definition} % Todo: Is this consise enough?
	% Happens before, Transitive Closure, Transitive Reduction, Collapsing, Filtering, No cycles in history
	\noindent We now expand the problem domain by allowing multiple events in the DCR graph distributed on multiple computers. We define:
	\begin{definition}
		A \textit{\textbf{neighbouring event}} of an event A is an event which event A has a relation to. \todo{Har vi defineret relation?}
	\end{definition}
	\noindent In this section all the events in the workflow are neighbours of the event responsible for generating the history in the DCR graph.
	
	\section{Merging histories} 
	In order to build a history for the events in the workflow, the actions of the events must be connected and partially ordered somehow. Due to the nature of actions being distributed, it is not possible to ensure a total order of actions. 
	
	For example if action $a$ on event $A$ knows that it has happened before action $b$ on event $B$, and action $c$ on event $C$, but there is no relation between event $B$ and $C$, then we have no way of knowing if action $b$ or $c$ happened first. This case can be seen on \autoref{fig:connect:partialorder}.
	\todo{Evt. Lamport-reference til hvad concurrent events er. }
	
	\begin{figure}
		\centering
		\import{5connect/images/}{partialorder.pdf_tex}
		\caption{The result of finding an order of execution when two events have no happens-before relations.}
		\label{fig:connect:partialorder}
	\end{figure}
	
	\subsection{Happens-before}
	The concept of happens-before relations helps determining what actions have happened before others across events.
	
	Recall that individual actions that have happened on an event will have happens-before relations between them, according to the rule that if $A$ and $B$ occur on the same process, then $A \rightarrow B$ if $A$ happened before $B$ on event $E$.
	Also recall that edges can be created between actions on two different events.
	
%	The concepts of transitivity, irreflexivity and antisymmetry also apply to happens-before relations. That is if $A \rightarrow B$ and $B \rightarrow C$, then $A \rightarrow C$ (transitivity), $A \not\rightarrow A$ (irreflexivity) and if $A \neq B$ and $A \rightarrow B$ then $B \not\rightarrow A$ (antisymmetry).
	
	\newpar As discussed in \autoref{chap:representing-a-history} an action can be seen from two perspectives: The perspective of the performer and the perspective of the receiver.
	Because the two actions represent sides of the same message exchange, we say that an initiation of this action happens before the action is logged on the receiving side. Therefore an edge can be created between the pairs of actions that correspond to each other. The types of actions that correspond are:
	
	\begin{definition}
		The following relations describe what action types happen before other action types.
			\begin{itemize}
				\item Includes $\rightarrow$ Included by
				\item Excludes $\rightarrow$ Excluded by
				\item Sets pending $\rightarrow$ Set pending by
				\item Checks condition $\rightarrow$ Checked condition by
				\item Locks $\rightarrow$ Locked by
				\item Unlocks $\rightarrow$ Unlocked by
			\end{itemize}
			\label{def:happensbeforeaction}
	\end{definition}
	
	\todo[inline]{Dette skal skrives om ...}
	\newpar Because multiple events can share action types, the types of two actions are not enough to determine whether or not that pair of actions is each others complement. Therefore the actions are also matched by the ID of the counterpart, seen from each side. Because the same event can possibly be executed multiple times, and thereby create multiple pairs of corresponding actions, at least one of the actions must know the local time stamp of the other. In the implementation we have chosen that the performer logs the time stamp of its counterpart as part of its action. With this information pairs of actions can uniquely be identified, eliminating the possibility of creating inconsistent histories due to mispaired data. Furthermore, an action can only match with a single other action following these rules. This limits the amount of both outgoing and incoming edges for each action to at most 2, due to the fact that an action is part of the local history for an event and has at most one mathed relation to an action of another event.
	
	Given this functionality provided by the happens before relations, an algorithm can be created to merge two histories together. First of all, every action of the history need to be added to a joined history. To connect actions, for each action of the graph the corresponding action is found by the rules described in the previous section. Whenever a match is found the edge is added from the performing action to the receiving action. With this algorithm a set of histories can then be merged together, two at a time, until one final combined history remains.
	\todo[inline]{... hertil.}	